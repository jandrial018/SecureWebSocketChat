const type={received:"received",sent:"sent"},chatContainer=document.getElementById("chatContainer"),log=document.getElementById("log"),received=document.getElementById("received"),sender=document.getElementById("sender"),counter=document.getElementById("count"),modal=document.getElementById("modal"),modalImg=document.getElementById("modalImg"),textbox=document.getElementById("message"),nameElement=document.getElementsByName("name")[0]??[],Connlabel=document.getElementById("statusText"),btn_fireworks=document.getElementById("btn_fireworks"),colors={sent:["#DCF8C6","#E1FFC7","#007AFF","#005C99","#A7F3D0","#2E7D32","#B3E5FC","#1976D2"],received:["#f4e8ab","#b4d2e9","#f3b9cc","#adadad","#eec5ef","#ff82cf","#E6E6E6","#93b4f6"]};var myColor="#e1f0ff";let fontColor="#00000",isConnected=!1;const statusLight=document.getElementById("statusLight"),statusText=document.getElementById("statusText"),label=document.getElementById("label");let messageID=1,id=0,uid=0;const options={hour:"2-digit",minute:"2-digit",hour12:!0};let cookies=[];function onColorChange(e){console.log("onColorChange",e.hexString)}function e(...e){console.log(...e)}function getCookies(){const e=document.cookie.split(";");let t=[];for(let n of e){const[e,o]=n.split("=");t[e.trim()]=decodeURIComponent(o)}return t}function setCookie(e,t,n=365){const o=new Date;o.setTime(o.getTime()+24*n*60*60*1e3);const s="expires="+o.toUTCString();document.cookie=`${encodeURIComponent(e)}=${encodeURIComponent(t)}; ${s}; path=/`}function startTimer(){if(countdown=document.getElementsByClassName("countdown")[0]??[],countdown&&countdown.classList.remove("displayNone"),timer=document.getElementById("timer"),timer){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate(),18,0,0);updateTimer(timer,t),setInterval((()=>updateTimer(timer,t)),1e3)}}let triggeredFire=!1;function updateTimer(e,t){let n=t-new Date,o="";n<=0&&n>-2&&(triggeredFire||(triggeredFire=!triggeredFire,triggerFireworks(),mydata={message:"https://media.tenor.com/M6JHx26JpjoAAAAC/spongebob-patrick-star.gif",name:"Server"},appendMessage(JSON.stringify(mydata),type.received)),o="+",n=Math.abs(n));const s=Math.floor(n/36e5),i=Math.floor(n%36e5/6e4),r=Math.floor(n%6e4/1e3),a=String(s).padStart(2,"0"),l=String(i).padStart(2,"0"),c=String(r).padStart(2,"0");e.textContent=`${o}${a}:${l}:${c}`}function findObjects(e,t){const n=/\.(jpeg|jpg|gif|png|webp)$/i,o=/www.youtube.com/;let s=null;return e.innerText=t,(s=e.textContent.match(/(https?:\/\/[^\s]+)/g))&&s.forEach((t=>{if(e.innerText=e.innerText.replace(t,""),t.match(n)){const n=document.createElement("img");n.src=t,n.style="max-width: 200px; display:block; border-radius: 9px;";const o=t.split("/"),s=o[o.length-1];n.setAttribute("data-gif-id",s),n.alt="animated gif: "+s,n.addEventListener("click",(()=>{openModal(t)})),e.appendChild(n)}else if(t.match(o)){const n=document.createElement("iframe");t=t.replace("/watch?v=","/embed/"),n.src=t,n.title="YouTube video player",n.frameborder="0",n.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",n.referrerpolicy="strict-origin-when-cross-origin",n.style="width: auto; height:auto; display:block; border-radius: 9px;",n.setAttribute("allowfullscreen",""),e.appendChild(n)}else{const n=document.createElement("a");n.target="_blank",n.href=t,n.textContent=t,e.appendChild(n)}})),t}function updateSmall(e){small=document.getElementById(e),small&&"true"!=small.getAttribute("sent")&&(small.innerHTML="Failed: "+getLocalTime())}function appendMessage(e,t){const n=JSON.parse(e??[]);if(n.uid==uid&&(t="sent"),n.count&&(counter.innerText=n.count),n.init)return myColor=n.color,fontColor=n.font,id=n.id,uid=n.uid??n.id,setCookie("id",n.id),setCookie("uid",n.uid),setCookie("color",n.color),setCookie("font",n.font),void(n.display&&startTimer());if(n.History)return n.History.forEach((e=>{appendMessage(JSON.stringify(e.data),t)})),void setTimeout((()=>{chatContainer.scrollTop=chatContainer.scrollHeight}),500);if(n.ping)return;if(n.received){let e=document.getElementById(n.received);return void(e&&(e.setAttribute("sent",!0),e.innerHTML="sent: "+getLocalTime()))}let o=n.message??"";const s=n.name??"Anon",i=document.createElement("div"),r=document.createElement("div");i.classList.add(t),r.classList.add("message");const a=document.createElement("p");o=(s?s+": ":"")+o,o=findObjects(a,o),i.appendChild(r),r.appendChild(a),r.style.backgroundColor=n.color??myColor,r.style.color=n.font??fontColor;const l=document.createElement("p");l.classList.add("small"),"sent"==t?(l.id=messageID++,l.innerHTML="sending...",l.setAttribute("sent",!1),n.uid==uid?l.innerHTML="sent: "+getLocalTime(n.time??null):setTimeout((()=>{updateSmall(l.id)}),3e3)):l.innerHTML="received: "+getLocalTime(n.time??null),i.appendChild(l),chatContainer.appendChild(i),setTimeout((()=>{chatContainer.scrollTop=chatContainer.scrollHeight}),200)}function clearMessage(){chatContainer.textContent="";const e=JSON.stringify({ClearHistory:1});isConnected&&ws.send(e)}function getHistory(){const e=JSON.stringify({GetHistory:1});isConnected&&ws.send(e)}function sendMessage(){if(null==textbox.value||!textbox.value.trim())return void flashTextareaAlert();const e=nameElement.value,t=JSON.stringify({id:id,uid:uid,name:e,message:textbox.value,messageID:messageID,color:myColor,font:fontColor});if(appendMessage(t,type.sent),isConnected)ws.send(t);else{appendMessage(JSON.stringify({name:"",message:"You're not connected to the server",messageID:messageID,color:myColor,font:fontColor}),type.received)}textbox.value=""}function getComplementaryColor(e){e=e.startsWith("#")?e.slice(1):e;let t=parseInt(e.substring(0,2),16),n=255-parseInt(e.substring(2,4),16),o=255-parseInt(e.substring(4,6),16);return`#${(255-t).toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`}function calculateLuminance(e){const t=parseInt(e.replace("#",""),16);return(.299*(t>>16&255)+.587*(t>>8&255)+.114*(255&t))/255}function setTextColor(e){return calculateLuminance(e)>.5?"#000000":"#ffffff"}function openModal(e){modal.classList.contains("displayNone")&&modal.classList.remove("displayNone");const t=e.split("/"),n=t[t.length-1];modalImg.setAttribute("data-gif-id",n),modalImg.src=e,modalImg.alt=`Select Image ${n} enlarged`}function closeModal(e){e.target.classList.contains("imgModal")&&modal.classList.add("displayNone")}function createFireBox(){let e=document.createElement("div");return e.id="fire",e.style.position="absolute",updateStyle(e),(document.getElementsByClassName("leftside")[0]??[]).append(e),e}function updateStyle(e){e||(e=document.getElementById("fire"));let t=chatContainer.getBoundingClientRect();e.style.top=t.top+"px",e.style.left=t.left+"px",e.style.height=t.height+"px",e.style.width=t.width+"px",e.style.pointerEvents="none"}nameElement.addEventListener("focusout",(()=>{setCookie("name",nameElement.value)})),modal.addEventListener("click",(e=>{closeModal(e)})),document.getElementById("message").addEventListener("keydown",(function(e){if("Enter"===e.key){if(e.shiftKey){const e=textbox.selectionStart,t=textbox.selectionEnd,n=textbox.value;textbox.value=n.substring(0,e)+"\n"+n.substring(t),textbox.selectionStart=textbox.selectionEnd=e+1}else sendMessage();e.preventDefault()}})),document.addEventListener("keydown",(function(e){(e.metaKey||e.ctrlKey)&&"l"===e.key&&(clearMessage(),e.preventDefault())}));let isRunning=!1,fireworks=null;function launchFireworks(){if(isRunning=!isRunning,isRunning){let e=null;fireworks?updateStyle():(e=createFireBox(),fireworks=new Fireworks.default(e)),fireworks.start()}else fireworks.stop()}function getLocalTime(e=null){if(e){const t=new Date(e),n=new Date;let o={hour:"2-digit",minute:"2-digit",hour12:!0};return t.getDate()!=n.getDate()&&(o.month="numeric",o.day="numeric"),t.getYear()!=n.getYear()&&(o.year="short"),t.toLocaleString(void 0,o)}return(new Date).toLocaleString(void 0,options)}function aboutMe(){Swal.fire({title:"Still Working on it",html:'Here is the public repo of this project:<br><br>GitHub: <a target="_blank" href="https://github.com/jandrial018/SecureWebSocketChat">https://github.com/jandrial018/SecureWebSocketChat</a><br><br>Speed test: <a target="_blank" href="https://pagespeed.web.dev/analysis/https-websocketchat-com/sugk601tha?form_factor=desktop">https://pagespeed.web.dev/analysis/</a>',confirmButtonText:"Close"})}function triggerFireworks(){if(isRunning)return launchFireworks(),void(btn_fireworks.style.background=ranColor());shootParticle()}function ranColor(){return`hsl(${Math.floor(361*Math.random())}, 100%, 50%)`}function randomLocation(){return{x:100*Math.random()-150+"px",y:200*Math.random()+120+"px"}}function shootParticle(){const e=[],t=ranColor(),n=document.createElement("span");n.classList.add("particle","move");const{x:o,y:s}=randomLocation();n.style.setProperty("--x",o),n.style.setProperty("--y",s),n.style.background=t,btn_fireworks.style.background=t,btn_fireworks.appendChild(n),e.push(n),setTimeout((()=>{for(let n=0;n<100;n++){const n=document.createElement("span");n.classList.add("particle","move"),n.style.transform=`translate(${o}, ${s})`;const i=200*Math.random()-100+"px",r=200*Math.random()-100+"px";n.style.setProperty("--x",`calc(${o} + ${i})`),n.style.setProperty("--y",`calc(${s} + ${r})`),n.style.animationDuration=300*Math.random()+200+"ms",n.style.background=t,btn_fireworks.appendChild(n),e.push(n)}setTimeout((()=>{e.forEach((e=>{e.remove()}))}),500),launchFireworks()}),500)}function flashTextareaAlert(){textbox.classList.contains("flash-alert")||(textbox.classList.add("flash-alert"),setTimeout((()=>{textbox.classList.remove("flash-alert")}),3e3))}btn_fireworks.addEventListener("click",triggerFireworks);let ws={};function startWebSocket(){cookies=getCookies();var e="wss://websocketchat.com:8443?source=user";Object.keys(cookies).forEach((t=>{t&&cookies[t]&&(e+="&"+t+"="+encodeURIComponent(cookies[t]))})),nameElement.value=cookies.name??"",uid=cookies.uid,myColor=cookies.color??"#e1f0ff";let t={};try{t=new WebSocket(e)}catch(e){console.log("catch",e)}return t}function sendPing(){if(isConnected){const e=JSON.stringify({ping:"pong"});ws.send(e),setTimeout((()=>{sendPing()}),5e4)}}document.addEventListener("DOMContentLoaded",(function(){ws=startWebSocket(),ws.onopen=e=>{statusLight.style.backgroundColor="#4CAF50",statusLight.title="Connected",statusText.textContent="Connected",label.textContent="Connected",isConnected=!0;appendMessage(JSON.stringify({message:"You've Have connected to server",name:""}),type.received),getHistory(),sendPing()},ws.onmessage=e=>{Connlabel.textContent="last msg from server: "+getLocalTime(),appendMessage(e.data,type.received)},ws.onclose=e=>{statusLight.style.backgroundColor="#f44336",statusLight.title="Disconnected",statusText.textContent="Disconnected",label.textContent="Disconnected",isConnected=!1,setTimeout((()=>{location.reload()}),15e3)},ws.onerror=e=>{statusLight.style.backgroundColor="#f44336",statusLight.title="Error",statusText.textContent="Error",label.textContent="Error",isConnected=!1;JSON.stringify(e);var t={message:"WebSocket error: unable to connect",name:""};appendMessage(JSON.stringify(t),type.received)}}));